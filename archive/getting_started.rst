Работа с сервисом «SMS Bulk»
============

.. |nbsp| unicode:: 0xA0
   :trim:


Принципы работы сервиса
---------------
Для отправки SMS-сообщения абоненту, партнеру необходимо послать POST или GET запрос на сервер системы «SMS Bulk» по адресу https://bulk.sms-online.com/.
Набор обязательных полей, который необходимо отправить на сервер системы рассылок складывается из обязательных общих полей и обязательных полей выбранного типа сообщения.

Система рассылок поддерживает следующие методы отправки сообщений:

* SMS – отправка SMS-сообщения;
* Viber – отправка сообщения через мессенджер Viber;
* USSD – отправка USSD-уведомления.

**Примечание:** по умолчанию, нашим партнёрам доступен только метод отправки "sms", остальные методы можно подключить через вашего менеджера.

Для того, чтобы отправить сообщение, вам необходимо отправить все обязательные параметры для выбранного метода отправки. Обязательные параметры есть в общих параметрах, а также в специфических параметрах для выбранного метода отправки.

Например, чтобы отправить SMS-сообщение, необходимо передать следующие параметры: user, from, phone, sign, txt.

Общие параметры
---------------


==================== ================== =============== ================================================================================
Параметр             Тип                Обязательный?   Описание
==================== ================== =============== ================================================================================
user                 String             да              Логин партнёра.
from                 String |nbsp| (11) да              Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number             да              Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                                        код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                                        несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String             да              Цифровая подпись, см. п. 4.2
sending_method       String             нет             Предпочитаемый метод отправки сообщения.

                                                        Допустимые значения:

                                                        * sms (по умолчанию)
                                                        * viber
                                                        * ussd
p_transaction_id     String             нет             Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                                        передаётся партнёру при передаче уведомлений о доставке
charset              String             нет             Кодировка параметра txt:
                                                        
                                                        * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                                        * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                                        * CP1251 – явное указание кодировки Windows-1251
delay                Number             нет             Отложить отправку сообщения абоненту на указанное количество минут.

                                                        Максимальное значение – 10080 (неделя).
dlr                  Number             нет             Отчёт о доставке сообщения:

                                                        * 0 (по умолчанию) – без отчета о доставке сообщения
                                                        * 1 – запросить отчет о доставке сообщения (см. п. 5)
==================== ================== =============== ================================================================================

В параметре «from» допустимо передавать числовое или символьное значение (только латинские буквы, цифры, пробелы). Телефонный аппарат абонента отобразит значение этого параметра в поле «От:» (зависит от модели). В целях безопасности доставка сообщений с произвольными параметрами from без согласования с менеджером «SMS Online» производиться не будет. После тестирования вы должны сообщить выбранный вами параметр «from» вашему менеджеру или через форму обратной связи для закрепления данного альфа-имени за вами.

Отправка SMS-сообщений
---------------

==================== ===================== =============== ================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ================================================================================
txt                  String |nbsp| (2048)  да              Текст отправляемого SMS-сообщения (по умолчанию – в кодировке UTF-8) 
pref                 String                нет             Режим сессии. Префикс для отправки ответных SMS-сообщений абонентов на сервис
                                                           партнера (см. режим сессии)
==================== ===================== =============== ================================================================================

Если сообщение содержит только символы из базового набора кодировки GSM 03.38, то при длине текста ≤ 160 символам будет тарифицировано одно MT-сообщение, при большей длине сообщение будет разбито на части по 153 символа и тарифицирована каждая часть.

Если сообщение содержит хотя бы один символ вне базового набора кодировки GSM 03.38 и  длина текста сообщения составит до 70 символов /включительно/, то будет тарифицировано одно MT-сообщение. Если длина ответа 71 и более символов, то количество сообщений будет 2 и более (длинные сообщения делятся на части и тарифицируются по 67 символов в соответствии со стандартами GSM).

Партнёр может передавать символ новой строки в параметре «txt» в том виде, в котором ему удобнее: в виде спецсимвола, в виде «\n» или «\r» или в виде «<br>». Система «SMS Bulk» распознает все варианты и отправит абоненту SMS с переводом строки.

**Пример:**

.. code-block:: none

    Расписание сеансов:<br>Зал1 10:30 Матрица<br>Зал2 11:00 Матрица2

Режим сессии
^^^^^^^^^^^^^^^^^^^^^^

Система «SMS Online» поддерживает работу в сессионном режиме: при отправке SMS абоненту можно указать префикс сессии (параметр «pref») для возможности отправки ответных сообщений (нажатие на кнопку «Ответить» в телефоне) на ваш сервис через систему «SMS Payment» (в случае необходимости, для получения документации на эту систему необходимо обратиться к менеджеру «SMS Online»).

.. note::
   Префикс должен быть подключен в системе «SMS Payment».


**Пример:** партнёр отправляет абоненту сообщение с параметрами:

.. code-block:: none

   from = 1320
   txt  = Для участия в викторине пришлите ваш возраст в ответ на эту SMS
   pref = VIKTORINA


Пользователю достаточно будет просто ответить на SMS-сообщение (нажать на кнопку «ответить» в телефоне). Например, он написал «26лет». Тогда на скрипт партнёра сообщение поступит в виде:

.. code-block:: none

   pref=VIKTORINA   txt=26лет

Режим сессии включается на срок 48 часов. Помимо конкурсов и викторин, данная функция может быть использована для отправки подтверждений, диалогов, чатов и т. д.


Отправка Viber-сообщений
------------------------

Система Viber-рассылок поддерживает несколько типов отправляемых сообщений:

* только текст – по умолчанию
* только изображение – абонент получает картинку
* текст + кнопка – абонент получает текстовое сообщение, под которым расположена кнопка. При нажатии на кнопку – происходит переход по заданной ссылке
* текст + кнопка + изображение – абонент получает текстовое сообщение, под которым расположены картинка и кнопка

Для каждого из типов отправляемых сообщений – задаются свои наборы параметров.

В случае, если у абонента нет мессенджера – система может автоматически отправлять SMS-сообщение абоненту (эта возможность подключается менеджером). Также доступна опция автоматической отправки SMS-сообщения абоненту, в случае если сообщение через Viber не доставлено в течение определенного периода.

**Особенности:**

* в параметре sending_method должно быть передано viber
* то, как будет выглядеть итоговое сообщение, определяется автоматически, исходя из переданных параметров;
* если параметр имеет пустое значение, то считается, что он не передан;
* в случае, если задан button_text, но не задан button_link (или наоборот) – кнопка отправлена не будет.

Только текст
^^^^^^^^^^^^

==================== ===================== =============== ================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ================================================================================
txt                  String |nbsp| (2048)  да              Текст отправляемого сообщения в кодировке UTF-8 
==================== ===================== =============== ================================================================================

Максимальная длина одного сообщения – 1 000 символов в кодировке UTF-8. В случае, если в параметре txt более, чем 1000 символов – сообщение будет разбито на части по 1 000 символов и каждая часть будет тарифцироваться отдельно.


Только изображение
^^^^^^^^^^^^^^^^^^

==================== ===================== =============== ================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ================================================================================
image_id             String |nbsp| (64)    да              ID загруженного изображения. Подробнее о загрузке изображений – см. п. 7
==================== ===================== =============== ================================================================================

При подсчёте цифровой подписи следует считать, что в txt передаётся пустая строка.


Текст + кнопка
^^^^^^^^^^^^^^

==================== ===================== =============== ================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ================================================================================
txt                  String |nbsp| (2048)  да              Текст отправляемого сообщения в кодировке UTF-8 
button_text          String |nbsp| (30)    да              Текст кнопки
button_link          String |nbsp| (2048)  да              Ссылка кнопки
==================== ===================== =============== ================================================================================

Текст + кнопка + изображение
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

==================== ===================== =============== ================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ================================================================================
txt                  String |nbsp| (2048)  да              Текст отправляемого сообщения в кодировке UTF-8 
image_id             String |nbsp| (64)    да              ID загруженного изображения. Подробнее о загрузке изображений – см. п. 7
button_text          String |nbsp| (30)    да              Текст кнопки
button_link          String |nbsp| (2048)  да              Ссылка кнопки
==================== ===================== =============== ================================================================================

Цифровая подпись
------------------------

Цифровая подпись необходима для проверки подлинности передаваемых данных. Для получения цифровой подписи сначала нужно склеить значения обязательных параметров запроса в определенной последовательности без разделителей. После склейки значений в конец строки добавляется секретный ключ («secret_key»), который известен только партнеру и «SMS Online». Далее, по полученной строке, считается MD5 хеш. MD5 хеш должен быть в шестнадцатеричном представлении (hex), а не в бинарном.

Последовательность объединения полей: user, from, phone, txt, secret_key

.. code-block:: none

   sign = md5( user + from + phone + txt + secret_key )

Знак '+' в приведённом примере используется как оператор склейки строк и не входит в состав строки. Если телефонов несколько, то при подписи они объединяются в порядке следования в запросе.

В случае, если параметр txt отсутствует в запросе – цифровую подпись следует считать следующим образом:

.. code-block:: none

    sign = md5( user + from + phone + secret_key )


Получение отчетов о доставке сообщений
--------------------------------------

Система поддерживает передачу партнёру информации о статусах доставки сообщений (DLR) абоненту. Если в запросе на отправку сообщения указывается параметр «dlr=1», то в ответном XML, помимо статуса, будет выдан идентификатор отправленного сообщения («msg_id»). Идентификаторов может быть больше одного в случае отправки сообщений для нескольких абонентов в одном запросе.

Для получения уведомления партнёру необходимо:
 
*  Разработать скрипт, принимающий уведомления о доставке (по HTTPS) в соответствии с описанным ниже протоколом, и сообщить его адрес менеджеру «SMS Online».
* Разрешить вызов скрипта с ip-адресов, присланных менеджером «SMS Online».
* Сообщить менеджеру, нужно ли доставлять промежуточные статусы или только финальные (см. п. 6.2).

Пример отправки сообщения с запросом DLR (для двух получателей, GET-запрос):

.. code-block:: none

    https://bulk.sms-online.com/?user=hitfm&from=HitFM&phone=79031234567&phone=79165557755&txt=%D0%A1%D1%8A%D0%B5%D1%88%D1%8C%20%D0%B5%D1%89%D0%B5%20%D1%8D%D1%82%D0%B8%D1%85%20%D1%84%D1%80%D0%B0%D0%BD%D1%86%D1%83%D0%B7%D1%81%D0%BA%D0%B8%D1%85%20%D0%B1%D1%83%D0%BB%D0%BE%D0%BA&sign=f7d36db5c9966c6200de7c8f3dcc890a&dlr=1

Ответ скрипта:

.. code-block:: xml

    <?xml version="1.0"?>
    <response>
        <tech_message>OK</tech_message>
        <code>0</code>
        <msg_id phone="79031234567">550e8400-e29b-41d4-a716-446655440000</msg_id>
        <msg_id phone="79165557755">550e8400-e29b-41d4-a716-446655440001</msg_id>
    </response>

Отчёты о доставке SMS-сообщений
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

При обновлении статуса доставки в системе «SMS Bulk», на вход скрипту партнёра будут передаваться три параметра:

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе "SMS Bulk"
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
status               Number                Код статуса доставки (см. п. 6.2)
==================== ===================== ================================================================================

Статусы доставки могут доставляться стандартными методами POST или GET и протоколами HTTP или HTTPS по выбору партнёра.

В ответ на запрос скрипт партнера должен вернуть HTTP-код ответа 200 OK с любым текстом. В случае иного HTTP-кода ответа уведомление будет отправляться повторно в течении 24 часов.


Отчёты о доставке Viber-сообщений
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Система рассылок поддерживает передачу расширенных статусов для Viber-сообщений.

Партнёру отправляются следующие типы уведомлений:

* уведомление о доставке сообщения
* уведомление о прочтении сообщения
* уведомление об ответе абонента на сообщение 

**Уведомление о доставке сообщения**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе "SMS Bulk"
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – delivery
status               String                Статус сообщения, возможные статусы:

                                           * delivered – доставлено
                                           * undelivered – не доставлено
                                           * buffered – в обработке
==================== ===================== ================================================================================

**Уведомление о прочтении сообщения**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе "SMS Bulk"
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – seen
==================== ===================== ================================================================================

**Уведомление об ответе абонента**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе "SMS Bulk"
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – reply
text                 String                Текст ответа абонента
==================== ===================== ================================================================================

Статусы доставки могут доставляться стандартными методами POST или GET и протоколами HTTP или HTTPS по выбору партнёра.

В ответ на запрос скрипт партнера должен вернуть HTTP-код ответа 200 OK с любым текстом. В случае иного HTTP-кода ответа уведомление будет отправляться повторно в течении 24 часов.

Коды ответов и статусов доставки
--------------------------------

Коды ответа системы «SMS Bulk»
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Обратите внимание, что безошибочный ответ («code=0») рассылочного скрипта не означает, что сообщение будет доставлено, а означает, что запрос принят в обработку системой. Статусы доставки передаются отдельно, см. п. 5.

==== ================================= ===============
Код  Описание                          Повтор запроса
==== ================================= ===============
0    Запрос успешно обработан          нет
-1   Неверные входные данные           нет
-2   Ошибка аутентификации             нет
-3   Отказ в обработке запроса         нет
-4   Временная техническая ошибка      да
-5   Исчерпан баланс SMS-сообщений     нет
==== ================================= ===============

Cтатусы доставки SMS-сообщений
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Статусы доставки передаются на скрипт партнёра, заданный в настройках системы «SMS Bulk».

=== ================== ========================================================= =====================
Код Значение           Описание                                                  Тип
=== ================== ========================================================= =====================
1   buffered           Сообщение в очереди на SMSC                               промежуточный
2   absent             Абонент вне зоны сети. Сообщение в очереди                промежуточный
3   preparing          Сообщение в процессе подготовки к отправлению             промежуточный
4   unknown            Неизвестный статус (ответ от оператора не получен)        промежуточный
-1  not delivered      Сообщение не доставлено (ошибка доставки)                 окончательный
-2  expired            Просрочено, удалено с SMSC (абонент недоступен 24ч.)      окончательный
-3  rejected           Отказ в передаче сообщения оператором (неверный номер,    окончательный
                       у абонента включен запрет приема СМС и др.)
=== ================== ========================================================= =====================

Все отправленные сообщения приобретают окончательный статус не более чем через 24 часа с момента отправки.





--->

**Только текст**
----------------------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     да              Текст отправляемого сообщения в кодировке UTF-8 
**Только изображение**
----------------------------------------------------------------------------------------------------------------------------------------------
image_id             String |nbsp| (64)       да              ID загруженного изображения. Подробнее о загрузке изображений – см. п. 7
**Текст + кнопка**
----------------------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     да              Текст отправляемого сообщения в кодировке UTF-8 
button_text          String |nbsp| (30)       да              Текст кнопки
button_link          String |nbsp| (2048)     да              Ссылка кнопки
**Текст + кнопка + изображение**
----------------------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     да              Текст отправляемого сообщения в кодировке UTF-8 
image_id             String |nbsp| (64)       да              ID загруженного изображения. Подробнее о загрузке изображений – см. п. 7
button_text          String |nbsp| (30)       да              Текст кнопки
button_link          String |nbsp| (2048)     да              Ссылка кнопки
**Общие параметры**
----------------------------------------------------------------------------------------------------------------------------------------------
