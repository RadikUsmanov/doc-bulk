Рассылка Viber
==============

Принципы работы
---------------

Система Viber-рассылок поддерживает несколько типов отправляемых сообщений:

* **только текст** – по умолчанию
* **только изображение** – абонент получает картинку
* **текст + кнопка** – абонент получает текстовое сообщение, под которым расположена кнопка. При нажатии на кнопку – происходит переход по заданной ссылке
* **текст + кнопка + изображение** – абонент получает текстовое сообщение, под которым расположены картинка и кнопка

В случае, если у абонента нет мессенджера – система может автоматически отправлять SMS-сообщение абоненту (возможность подключается менеджером). Также доступна опция автоматической отправки SMS-сообщения абоненту, в случае если сообщение через Viber не доставлено в течение определенного периода.

**Особенности:**

* то, как будет выглядеть итоговое сообщение, определяется автоматически, исходя из переданных параметров
* если параметр имеет пустое значение, то считается, что он не передан
* в случае, если задан button_text, но не задан button_link (или наоборот) – кнопка отправлена не будет


Отправка Viber-сообщений
------------------------

Для отправки сообщения абоненту, партнеру необходимо послать POST или GET запрос на сервер системы «Bulk» по адресу https://bulk.sms-online.com/.

.. |nbsp| unicode:: 0xA0
   :trim:

Текстовое сообщение
^^^^^^^^^^^^^^^^^^^

==================== ======================== ================================================================================
Параметр             Тип                      Описание
==================== ======================== ================================================================================
**Обязательные параметры**
------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     Текст отправляемого сообщения в кодировке UTF-8.
user                 String                   Логин партнёра.
from                 String |nbsp| (11)       Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number                   Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                              код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                              несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String                   `Цифровая подпись`_
sending_method       String                   Должно быть значение: viber
**Опциональные параметры**
------------------------------------------------------------------------------------------------------------------------------
p_transaction_id     String                   Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                              передаётся партнёру при передаче уведомлений о доставке
charset              String                   Кодировка параметра txt:

                                              * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                              * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                              * CP1251 – явное указание кодировки Windows-1251
delay                Number                   Отложить отправку сообщения абоненту на указанное количество минут.

                                              Максимальное значение – 10080 (неделя).
dlr                  Number                   Отчёт о доставке сообщения:

                                              * 0 (по умолчанию) – без отчета о доставке сообщения
                                              * 1 – запросить отчет о доставке сообщения (см. п. 5)
dlr_timeout          Number                   Время в секундах, в течение которого интересует доставка сообщения.

                                              По умолчанию – 86400 (сутки), минимальное значение – 10,
                                              максимальное значение – 172800.
                                              
                                              Этот параметр используется для того, чтобы оперативно отправлять сообщения по
                                              каналу, отличному от Viber (SMS, USSD или подобное)
==================== ======================== ================================================================================


Изображение
^^^^^^^^^^^

==================== ======================== ================================================================================
Параметр             Тип                      Описание
==================== ======================== ================================================================================
**Обязательные параметры**
------------------------------------------------------------------------------------------------------------------------------
image_id             String |nbsp| (64)       ID загруженного изображения. Подробнее о загрузке изображений – см.
                                              :ref:`загрузка медиа-файлов <ref-media>`
user                 String                   Логин партнёра.
from                 String |nbsp| (11)       Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number                   Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                              код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                              несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String                   `Цифровая подпись`_
sending_method       String                   Должно быть значение: viber
**Опциональные параметры**
------------------------------------------------------------------------------------------------------------------------------
p_transaction_id     String                   Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                              передаётся партнёру при передаче уведомлений о доставке
charset              String                   Кодировка параметра txt:

                                              * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                              * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                              * CP1251 – явное указание кодировки Windows-1251
delay                Number                   Отложить отправку сообщения абоненту на указанное количество минут.

                                              Максимальное значение – 10080 (неделя).
dlr                  Number                   Отчёт о доставке сообщения:

                                              * 0 (по умолчанию) – без отчета о доставке сообщения
                                              * 1 – запросить отчет о доставке сообщения (см. п. 5)
dlr_timeout          Number                   Время в секундах, в течение которого интересует доставка сообщения.

                                              По умолчанию – 86400 (сутки), минимальное значение – 10,
                                              максимальное значение – 172800.
                                              
                                              Этот параметр используется для того, чтобы оперативно отправлять сообщения по
                                              каналу, отличному от Viber (SMS, USSD или подобное)
==================== ======================== ================================================================================


Текст и кнопка
^^^^^^^^^^^^^^

==================== ======================== ================================================================================
Параметр             Тип                      Описание
==================== ======================== ================================================================================
**Обязательные параметры**
------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     Текст отправляемого сообщения в кодировке UTF-8.
button_text          String |nbsp| (30)       Текст кнопки
button_link          String |nbsp| (2048)     Ссылка кнопки
user                 String                   Логин партнёра.
from                 String |nbsp| (11)       Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number                   Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                              код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                              несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String                   `Цифровая подпись`_
sending_method       String                   Должно быть значение: viber
**Опциональные параметры**
------------------------------------------------------------------------------------------------------------------------------
p_transaction_id     String                   Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                              передаётся партнёру при передаче уведомлений о доставке
charset              String                   Кодировка параметра txt:

                                              * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                              * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                              * CP1251 – явное указание кодировки Windows-1251
delay                Number                   Отложить отправку сообщения абоненту на указанное количество минут.

                                              Максимальное значение – 10080 (неделя).
dlr                  Number                   Отчёт о доставке сообщения:

                                              * 0 (по умолчанию) – без отчета о доставке сообщения
                                              * 1 – запросить отчет о доставке сообщения (см. п. 5)
dlr_timeout          Number                   Время в секундах, в течение которого интересует доставка сообщения.

                                              По умолчанию – 86400 (сутки), минимальное значение – 10,
                                              максимальное значение – 172800.
                                              
                                              Этот параметр используется для того, чтобы оперативно отправлять сообщения по
                                              каналу, отличному от Viber (SMS, USSD или подобное)
==================== ======================== ================================================================================

Текст, кнопка и изображение
^^^^^^^^^^^^^^^^^^^^^^^^^^^

==================== ======================== ================================================================================
Параметр             Тип                      Описание
==================== ======================== ================================================================================
**Обязательные параметры**
------------------------------------------------------------------------------------------------------------------------------
txt                  String |nbsp| (2048)     Текст отправляемого сообщения в кодировке UTF-8.
image_id             String |nbsp| (64)       ID загруженного изображения. Подробнее о загрузке изображений – см.
                                              :ref:`загрузка медиа-файлов <ref-media>`
button_text          String |nbsp| (30)       Текст кнопки
button_link          String |nbsp| (2048)     Ссылка кнопки
user                 String                   Логин партнёра.
from                 String |nbsp| (11)       Альфа-имя отправителя сообщения – цифры или латинские символы
phone[1..n]          Number                   Номер телефона получателя в международном формате: только цифры, без знака «плюс»,
                                              код страны, код оператора, телефон. Если необходимо отправить сообщение на
                                              несколько номеров, то требуется передавать несколько полей «phone» 
sign                 String                   `Цифровая подпись`_
sending_method       String                   Должно быть значение: viber
**Опциональные параметры**
------------------------------------------------------------------------------------------------------------------------------
p_transaction_id     String                   Идентификатор транзакции в системе партнёра. Используется для сверок статистики и
                                              передаётся партнёру при передаче уведомлений о доставке
charset              String                   Кодировка параметра txt:

                                              * UTF8 или UTF-8 (по умолчанию) – явное указание кодировки Unicode UTF-8
                                              * UTF-16BE или UCS-2 – кодировка Unicode UTF-16 Big Endian
                                              * CP1251 – явное указание кодировки Windows-1251
delay                Number                   Отложить отправку сообщения абоненту на указанное количество минут.

                                              Максимальное значение – 10080 (неделя).
dlr                  Number                   Отчёт о доставке сообщения:

                                              * 0 (по умолчанию) – без отчета о доставке сообщения
                                              * 1 – запросить отчет о доставке сообщения (см. п. 5)
dlr_timeout          Number                   Время в секундах, в течение которого интересует доставка сообщения.

                                              По умолчанию – 86400 (сутки), минимальное значение – 10,
                                              максимальное значение – 172800.
                                              
                                              Этот параметр используется для того, чтобы оперативно отправлять сообщения по
                                              каналу, отличному от Viber (SMS, USSD или подобное)
==================== ======================== ================================================================================


Цифровая подпись
^^^^^^^^^^^^^^^^
.. include:: includes/bulk_sign.rst


Коды ответа системы «Bulk»
------------------------------

Система «Bulk» отвечает на запросы об отправке SMS-сообщений в XML.

**Примеры ответов системы:**

.. code-block:: xml

    <!-- Если запрос соответствует протоколу, то ответ скрипта будет таким -->
    <?xml version="1.0" encoding="utf-8"?>
    <response>
      <code>0</code>
      <tech_message>OK</tech_message>
    </response>

.. code-block:: xml

    <!-- Если произошла ошибка, то параметр «code» будет меньше нуля. В этом случае поле «tech_message» содержит текстовое описание ошибки. -->
    <?xml version="1.0" encoding="utf-8"?>
    <response>
      <code>-1</code>
      <tech_message>PARAM ERROR (phone)</tech_message>
    </response>

По умолчанию установлено ограничение для SMS рассылок: 10 SMS/секунду. Если требуется более высокая скорость – сообщите об этом вашему менеджеру.

Обратите внимание, что безошибочный ответ («code=0») рассылочного скрипта не означает, что сообщение будет доставлено, а означает, что запрос принят в обработку системой.

**Расшифровка кодов ответов системы:**

==== ================================= ===============
Код  Описание                          Повтор запроса
==== ================================= ===============
0    Запрос успешно обработан          нет
-1   Неверные входные данные           нет
-2   Ошибка аутентификации             нет
-3   Отказ в обработке запроса         нет
-4   Временная техническая ошибка      да
-5   Исчерпан баланс SMS-сообщений     нет
==== ================================= ===============


Отчёты о доставке
-----------------

Система поддерживает передачу партнёру информации о статусах доставки сообщений (DLR) абоненту. Если в запросе на отправку сообщения указывается параметр «dlr=1», то в ответном XML, помимо статуса, будет выдан идентификатор отправленного сообщения («msg_id»). Идентификаторов может быть больше одного в случае отправки сообщений для нескольких абонентов в одном запросе.


**Пример ответа системы с msg_id:**

.. code-block:: xml

    <?xml version="1.0"?>
    <response>
        <tech_message>OK</tech_message>
        <code>0</code>
        <msg_id phone="79031234567">550e8400-e29b-41d4-a716-446655440000</msg_id>
        <msg_id phone="79165557755">550e8400-e29b-41d4-a716-446655440001</msg_id>
    </response>


Для получения уведомления партнёру необходимо:

*  Разработать скрипт, принимающий уведомления о доставке (по HTTPS) в соответствии с описанным ниже протоколом, и сообщить его адрес менеджеру «SMS Online».
* Разрешить вызов скрипта с ip-адресов, присланных менеджером «SMS Online».
* Сообщить менеджеру, нужно ли доставлять промежуточные статусы или только финальные.


Стандартные отчёты о доставке
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

При обновлении статуса доставки в системе «Bulk», на вход скрипту партнёра будут передаваться три параметра:

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе «Bulk»
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
status               Number                Код статуса доставки
==================== ===================== ================================================================================

Статусы доставки могут доставляться стандартными методами POST или GET и протоколами HTTP или HTTPS по выбору партнёра.

В ответ на запрос скрипт партнера должен вернуть HTTP-код ответа 200 OK с любым текстом. В случае иного HTTP-кода ответа уведомление будет отправляться повторно в течении 24 часов.

Статусы доставки передаются на скрипт партнёра, заданный в настройках системы «Bulk».

**Коды статусов доставки**

=== ================== =========================================================
Код Значение           Описание                                                 
=== ================== =========================================================
0   delivered          Сообщение успешно доставлено
-1  not delivered      Сообщение не доставлено (ошибка доставки)                
-2  expired            Просрочено, удалено с SMSC (абонент недоступен 24ч.)     
-3  rejected           Отказ в передаче сообщения оператором (неверный номер,   
                       у абонента включен запрет приема СМС и др.)
=== ================== =========================================================

Расширенные отчёты о доставке
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Система рассылок поддерживает передачу расширенных статусов для Viber-сообщений.

Партнёру отправляются следующие типы уведомлений:

* уведомление о доставке сообщения
* уведомление о прочтении сообщения
* уведомление об ответе абонента на сообщение 

**Уведомление о доставке сообщения**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе «Bulk»
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – delivery
status               String                Статус сообщения, возможные статусы:

                                           * delivered – доставлено
                                           * undelivered – не доставлено
                                           * buffered – в обработке
status_extended      String                Расширенная причина недоставки сообщения абоненту, передаётся
                                           при status=undelivered
                                           
                                           Возможные значения:
                                           
                                           * **VIBER_BLOCKED_BY_USER** - абонент заблокировал имя отправителя
                                           * **VIBER_USER_NOT_FOUND** - на мобильном устройстве абонента не установлено
                                             актуальное Viber-приложение
                                           * **VIBER_NO_DEVICE** - для мобильного устройства абонента не предусмотрены
                                             Viber-рассылки (как правило это планшеты)
                                           * **VIBER_UNKNOWN_ERROR** - неопределенная ошибка (уточнение по запросу)

                                           *Опциональный параметр, подключается по запросу партнёра*
==================== ===================== ================================================================================

**Уведомление о прочтении сообщения**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе «Bulk»
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – seen
==================== ===================== ================================================================================

**Уведомление об ответе абонента**

==================== ===================== ================================================================================
Параметр             Тип                   Описание
==================== ===================== ================================================================================
msg_id               String |nbsp| (36)    Идентификатор сообщения в системе «Bulk»
p_transaction_id     String                Информация, переданная партнёром в запросе на отправку сообщения
type                 String                Тип уведомления, в данном случае – reply
text                 String                Текст ответа абонента
==================== ===================== ================================================================================

Статусы доставки могут доставляться стандартными методами POST или GET и протоколами HTTP или HTTPS по выбору партнёра.

В ответ на запрос скрипт партнера должен вернуть HTTP-код ответа 200 OK с любым текстом. В случае иного HTTP-кода ответа уведомление будет отправляться повторно в течение 24 часов.


.. _ref-media:

Загрузка медиа-файлов
---------------------

Загрузка файлов производится путём передачи содержимого загружаемых файлов на адрес : https://media.sms-online.com/upload/ POST-запросом. 

.. note:: Файлы должны передаваться в формате multipart/form-data.

==================== ===================== =============== ====================================================================================
Параметр             Тип                   Обязательный?   Описание
==================== ===================== =============== ====================================================================================
login                String                да              Логин партнёра.
image                File                  да              Медиа-файл.

                                                           Допустимые форматы: JPG, PNG, GIF.

                                                           Максимальный размер: 10Мб.
sign                 String                да              Цифровая подпись, формируемая по алгоритму: md5( login + md5(file) + secret_key )
==================== ===================== =============== ====================================================================================


В случае, если загрузка файла прошла успешно, вы получите ответ вида:

.. code::

    {"status": 0, "image_id": "AVESK8...VHUQA8"}

где image_id – 64-символьный уникальный ID изображения.


В случае, если при загрузка файла произошла ошибка, вы получите ответ вида:

.. code::

    {"status": 2, error: "Invalid sign"}
    
где status – это код ошибки, error – текстовое описание ошибки.


**Расшифровка кодов ошибок**

==== ======================================================================
Код  Описание
==== ======================================================================
1    Некорректно переданы данные.

     Какие именно данные переданы неверно – будет написано в error. 
2    Некорректная подпись. 
3    Превышен размер загружаемого файла.
    
     Максимальный размер – 10Мб. 
4    Загружен файл недопустимого формата. 

     Допустимые форматы файлов: JPG, GIF, PNG.
==== ======================================================================     
